# ─── Saubh.Tech — Production Caddyfile ──────────────────────────────
#
# Prerequisites:
#   - Cloudflare DNS proxying enabled (orange cloud)
#   - Cloudflare SSL mode: Full (Strict)
#   - Caddy obtains its own TLS cert via ACME (Cloudflare validates upstream)
#
# Copy this file to /etc/caddy/Caddyfile and reload:
#   sudo systemctl reload caddy
#
# ─────────────────────────────────────────────────────────────────────

# ─── Global options ─────────────────────────────────────────────────
{
	# Restrict admin API to localhost
	admin localhost:2019

	# Trust Cloudflare proxy IPs so X-Forwarded-For is accurate.
	# Update these ranges periodically from:
	# https://www.cloudflare.com/ips-v4 and /ips-v6
	servers {
		trusted_proxies static \
			173.245.48.0/20 \
			103.21.244.0/22 \
			103.22.200.0/22 \
			103.31.4.0/22 \
			141.101.64.0/18 \
			108.162.192.0/18 \
			190.93.240.0/20 \
			188.114.96.0/20 \
			197.234.240.0/22 \
			198.41.128.0/17 \
			162.158.0.0/15 \
			104.16.0.0/13 \
			104.24.0.0/14 \
			172.64.0.0/13 \
			131.0.72.0/22 \
			2400:cb00::/32 \
			2606:4700::/32 \
			2803:f800::/32 \
			2405:b500::/32 \
			2405:8100::/32 \
			2a06:98c0::/29 \
			2c0f:f248::/32
	}
}

# ─── saubh.tech → Next.js web app (port 3000) ──────────────────────
saubh.tech {
	# Reverse proxy to Next.js
	reverse_proxy localhost:3000 {
		# Pass real client IP from Cloudflare
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	# Security headers (supplement what Next.js sets)
	header {
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	# Gzip + zstd compression
	encode zstd gzip

	log {
		output file /var/log/caddy/saubh-web.log {
			roll_size 50MiB
			roll_keep 5
		}
	}
}

# ─── api.saubh.tech → NestJS API (port 3001) ───────────────────────
api.saubh.tech {
	reverse_proxy localhost:3001 {
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	header {
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		-Server
	}

	encode zstd gzip

	log {
		output file /var/log/caddy/saubh-api.log {
			roll_size 50MiB
			roll_keep 5
		}
	}
}

# ─── realtime.saubh.tech → Realtime server (port 3002) ─────────────
# TODO Phase 2: WebSocket / SSE server for chat, notifications, etc.
realtime.saubh.tech {
	reverse_proxy localhost:3002 {
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-Proto {scheme}

		# WebSocket support
		header_up Connection {>Connection}
		header_up Upgrade {>Upgrade}
	}

	header {
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		-Server
	}

	log {
		output file /var/log/caddy/saubh-realtime.log {
			roll_size 50MiB
			roll_keep 5
		}
	}
}
